---
import type { ArticleQueryResult } from '@/types/sanity.types';
import { urlFor } from '@/utils/image';
import { formatDate } from '@/utils/index';
import { toPlainText } from 'astro-portabletext';

interface Props {
    article: NonNullable<ArticleQueryResult>;
    accentColor?: string;
}

const { article, accentColor = '#10B981' } = Astro.props;

// We need to augment the Article type to match what's returned from the GROQ query
type ExtendedCategory = {
    _id: string;
    title: string;
};

// Cast categories to the extended type that includes title
const categories = article.categories as unknown as
    | ExtendedCategory[]
    | undefined;
---

<a href={`/${article.slug?.current}`} class="group block">
    <article
        class="bg-white border border-neutral-200 hover:border-neutral-400 transition-all duration-150 h-full flex flex-col"
        style={`border-left: 4px solid ${accentColor}; border-radius: 4px;`}
    >
        {
            article.mainImage && article.mainImage.asset && (
                <div class="overflow-hidden" style="border-radius: 0 0 0 0;">
                    <img
                        src={urlFor(article.mainImage.asset)
                            .width(400)
                            .height(250)
                            .url()}
                        alt={article.title || 'Straipsnio nuotrauka'}
                        class="w-full h-48 object-cover opacity-70"
                        loading="lazy"
                    />
                </div>
            )
        }

        <div class="p-6 flex-1 flex flex-col">
            <div class="flex items-center gap-3 mb-3">
                {
                    categories && categories.length > 0 && (
                        <span
                            class="text-xs font-medium tracking-wider uppercase px-3 py-1"
                            style={`font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em; background: ${accentColor}20; color: ${accentColor}; border-radius: 4px;`}
                        >
                            {categories[0].title}
                        </span>
                    )
                }
                <time datetime={article._updatedAt} class="text-xs text-neutral-400">
                    {formatDate(article._updatedAt)}
                </time>
            </div>

            <h2
                class="text-base sm:text-lg font-medium tracking-wide uppercase mb-3 group-hover:text-neutral-600 transition-colors"
                style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.02em; line-height: 1.4;"
            >
                {article.title}
            </h2>

            <p class="text-sm text-neutral-600 leading-relaxed mb-4 flex-1">
                {toPlainText(article.body!).slice(0, 150).trim()}...
            </p>

            <div class="flex justify-between items-center text-xs text-neutral-400 pt-4 border-t border-neutral-100">
                <span>{article.views || 0} peržiūrų</span>
            </div>
        </div>
    </article>
</a>
