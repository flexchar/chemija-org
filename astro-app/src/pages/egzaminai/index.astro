---
import Layout from '@/layouts/Layout.astro';
import { getExams } from '@/utils/sanity';

const exams = await getExams();

// Extract unique years from exams for the filter
const examYears = [
    ...new Set(
        exams
            .map((exam) =>
                exam.year ? new Date(exam.year).getFullYear() : null,
            )
            .filter((year) => year !== null),
    ),
].sort((a, b) => b - a); // Sort years in descending order
---

<Layout title="Chemijos egzaminai">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page header / intro -->
        <header class="pt-6">
            <h1 class="text-3xl sm:text-4xl font-semibold mb-2">
                Chemijos egzaminai
            </h1>
            <p class="text-base-content/70">
                Chemijos valstybinių bei mokyklinių egzaminų užduočių ir
                atsakymų archyvas. Egzaminai su atsakymais nuo 1996 metų.
            </p>
        </header>

        <!-- Controls -->
        <div class="mt-6">
            <div class="form-control w-full max-w-xs">
                <label class="label">
                    <span class="label-text"> Filtruoti pagal metus </span>
                </label>
                <select
                    class="select select-bordered w-full max-w-xs"
                    id="yearFilter"
                >
                    <option value="">Visi metai</option>
                    {
                        examYears.map((year) => (
                            <option value={year}>{year}</option>
                        ))
                    }
                </select>
            </div>
        </div>

        <!-- Table card -->
        <div class="card bg-base-100/60 border border-base-200/70 mt-6">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr class="bg-base-200/60 text-base-content/70">
                            <th>Metai</th>
                            <th>Tipas</th>
                            <th>Sesija</th>
                            <th>Užduotys</th>
                            <th>Atsakymai</th>
                        </tr>
                    </thead>
                    <tbody id="examsTableBody">
                        {
                            exams.map((exam) => (
                                <tr
                                    class="hover:bg-base-200/40"
                                    data-year={
                                        exam.year
                                            ? new Date(exam.year).getFullYear()
                                            : ''
                                    }
                                >
                                    <td>
                                        {exam.year
                                            ? new Date(exam.year).getFullYear()
                                            : 'N/A'}
                                    </td>
                                    <td>{exam.level || 'N/A'}</td>
                                    <td>{exam.session || 'Pagrindinė'}</td>
                                    <td>
                                        {exam.questions_url ? (
                                            <div class="flex flex-wrap gap-2">
                                                <a
                                                    href={exam.questions_url}
                                                    class="btn btn-ghost btn-xs transition-colors hover:bg-base-200 hover:text-primary"
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    Žiūrėti
                                                </a>
                                                <a
                                                    href={`${exam.questions_url}?dl=${`${exam.year ? new Date(exam.year).getFullYear() : ''} chemijos ${exam.level || ''} egzaminas - užduotys`.toLowerCase()}.pdf`}
                                                    class="btn btn-ghost btn-xs transition-colors hover:bg-base-200 hover:text-primary"
                                                >
                                                    Siųsti
                                                </a>
                                            </div>
                                        ) : (
                                            <span class="text-base-content/50">
                                                Nėra
                                            </span>
                                        )}
                                    </td>
                                    <td>
                                        {exam.answers_url ? (
                                            <div class="flex flex-wrap gap-2">
                                                <a
                                                    href={exam.answers_url}
                                                    class="btn btn-ghost btn-xs transition-colors hover:bg-base-200 hover:text-primary"
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    Žiūrėti
                                                </a>
                                                <a
                                                    href={`${exam.answers_url}?dl=${`${exam.year ? new Date(exam.year).getFullYear() : ''} chemijos ${exam.level || ''} egzaminas - atsakymai`.toLowerCase()}.pdf`}
                                                    class="btn btn-ghost btn-xs transition-colors hover:bg-base-200 hover:text-primary"
                                                >
                                                    Siųsti
                                                </a>
                                            </div>
                                        ) : (
                                            <span class="text-base-content/50">
                                                Nėra
                                            </span>
                                        )}
                                    </td>
                                </tr>
                            ))
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</Layout>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const yearFilter = document.getElementById(
            'yearFilter',
        ) as HTMLSelectElement;

        // Filter exams by year
        const filterExamsByYear = () => {
            const selectedYear = yearFilter.value;
            const rows = document.querySelectorAll('#examsTableBody tr');

            rows.forEach((row) => {
                const rowYear = row.getAttribute('data-year');
                if (!selectedYear || rowYear === selectedYear) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        };

        // Add event listeners
        yearFilter.addEventListener('change', filterExamsByYear);
    });
</script>
