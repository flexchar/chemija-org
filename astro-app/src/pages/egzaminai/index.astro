---
import Layout from '@/layouts/Layout.astro';
import { getExams } from '@/utils/sanity';

const exams = await getExams();

// Extract unique years from exams for the filter
const examYears = [
    ...new Set(
        exams
            .map((exam) =>
                exam.year ? new Date(exam.year).getFullYear() : null,
            )
            .filter((year) => year !== null),
    ),
].sort((a, b) => b - a); // Sort years in descending order
---

<Layout title="Chemijos egzaminai">
    <div class="max-w-[1400px] mx-auto px-6 sm:px-12 py-16">
        <!-- Page header -->
        <header class="mb-12">
            <h1
                class="text-2xl sm:text-3xl font-medium tracking-wider uppercase mb-4"
                style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.1em;"
            >
                EGZAMINŲ ARCHYVAS
            </h1>
            <div class="h-px bg-neutral-200"></div>
            <p class="mt-6 text-sm text-neutral-600 max-w-2xl">
                Chemijos valstybinių bei mokyklinių egzaminų užduočių ir
                atsakymų archyvas. Duomenys nuo 1996 metų.
            </p>
        </header>

        <!-- Filter Controls -->
        <div class="mb-8">
            <label
                class="block text-xs font-medium tracking-wider uppercase text-neutral-700 mb-2"
                style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em;"
            >
                FILTRUOTI PAGAL METUS
            </label>
            <select
                class="bg-white border border-neutral-200 text-sm text-neutral-900 px-4 py-3 w-full max-w-xs focus:border-black focus:outline-none transition-colors"
                style="border-radius: 4px; font-family: 'IBM Plex Mono', monospace;"
                id="yearFilter"
            >
                <option value="">Visi metai</option>
                {examYears.map((year) => <option value={year}>{year}</option>)}
            </select>
        </div>

        <!-- Table -->
        <div
            class="bg-white border border-neutral-200 overflow-hidden"
            style="border-radius: 4px;"
        >
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-neutral-50 border-b border-neutral-200">
                            <th
                                class="text-left px-6 py-4 text-xs font-medium tracking-wider uppercase text-neutral-500"
                                style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em;"
                            >
                                METAI
                            </th>
                            <th
                                class="text-left px-6 py-4 text-xs font-medium tracking-wider uppercase text-neutral-500"
                                style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em;"
                            >
                                LYGIS
                            </th>
                            <th
                                class="text-left px-6 py-4 text-xs font-medium tracking-wider uppercase text-neutral-500"
                                style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em;"
                            >
                                SESIJA
                            </th>
                            <th
                                class="text-left px-6 py-4 text-xs font-medium tracking-wider uppercase text-neutral-500"
                                style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em;"
                            >
                                UŽDUOTYS
                            </th>
                            <th
                                class="text-left px-6 py-4 text-xs font-medium tracking-wider uppercase text-neutral-500"
                                style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em;"
                            >
                                ATSAKYMAI
                            </th>
                        </tr>
                    </thead>
                    <tbody id="examsTableBody">
                        {
                            exams.map((exam) => (
                                <tr
                                    class="border-b border-neutral-100 hover:bg-neutral-50 transition-colors"
                                    data-year={
                                        exam.year
                                            ? new Date(exam.year).getFullYear()
                                            : ''
                                    }
                                >
                                    <td class="px-6 py-4 text-sm text-neutral-900">
                                        {exam.year
                                            ? new Date(exam.year).getFullYear()
                                            : 'N/A'}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-neutral-900">
                                        {exam.level || 'N/A'}
                                    </td>
                                    <td class="px-6 py-4 text-sm text-neutral-900">
                                        {exam.session || 'Pagrindinė'}
                                    </td>
                                    <td class="px-6 py-4">
                                        {exam.questions_url ? (
                                            <div class="flex gap-2">
                                                <a
                                                    href={exam.questions_url}
                                                    class="text-xs font-medium tracking-wider uppercase text-black hover:text-neutral-600 underline transition-colors"
                                                    style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em;"
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    PERŽIŪRĖTI
                                                </a>
                                            </div>
                                        ) : (
                                            <span class="text-xs text-neutral-400">
                                                —
                                            </span>
                                        )}
                                    </td>
                                    <td class="px-6 py-4">
                                        {exam.answers_url ? (
                                            <div class="flex gap-2">
                                                <a
                                                    href={exam.answers_url}
                                                    class="text-xs font-medium tracking-wider uppercase text-black hover:text-neutral-600 underline transition-colors"
                                                    style="font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.05em;"
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                >
                                                    PERŽIŪRĖTI
                                                </a>
                                            </div>
                                        ) : (
                                            <span class="text-xs text-neutral-400">
                                                —
                                            </span>
                                        )}
                                    </td>
                                </tr>
                            ))
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</Layout>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const yearFilter = document.getElementById(
            'yearFilter',
        ) as HTMLSelectElement;

        // Filter exams by year
        const filterExamsByYear = () => {
            const selectedYear = yearFilter.value;
            const rows = document.querySelectorAll('#examsTableBody tr');

            rows.forEach((row) => {
                const rowYear = row.getAttribute('data-year');
                if (!selectedYear || rowYear === selectedYear) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        };

        // Add event listeners
        yearFilter.addEventListener('change', filterExamsByYear);
    });
</script>
